<!DOCTYPE html> <html lang="en" dir="ltr" itemtype="http://schema.org/WebPage" itemscope=""> <head> <meta charset="utf-8"> <meta http-equiv="X-UA-Compatible" content="IE=edge"> <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no"> <meta name="HandheldFriendly" content="true"/> <title>Building a simple company website the Hard Way: Service workers | Fragaria.cz</title> <meta name="author" content="Fragaria s.r.o."/> <meta name="robots" content="index,follow"/> <meta name="description" content="Hi there once again! I’m gonna close our little Building a simple company website the Hard Way series with a brief introduction to how service workers operate and why you should want them on your website, too. They’re cool and fancy, sometimes unnecessary, but likely still worth your time as I’m about to demonstrate."> <meta name="keywords" content="software, software development, web apps, vývoj software, webové aplikace, python, javascript, typescript, java, angular, vue, elasticsearch, html, css, javascript, service workers, progressive web apps"/> <meta property="og:url" content="https://fragaria.cz/blog/2019/04/08/building-a-simple-company-website-the-hard-way-service-workers/"/> <meta property="og:type" content="website"/> <meta property="og:title" content="Building a simple company website the Hard Way: Service workers | Fragaria.cz"/> <meta property="og:description" content="Hi there once again! I’m gonna close our little Building a simple company website the Hard Way series with a brief introduction to how service workers operate and why you should want them on your website, too. They’re cool and fancy, sometimes unnecessary, but likely still worth your time as I’m about to demonstrate."/> <meta property="og:image" content="https://res.cloudinary.com/fragaria/image/upload/w_640,c_fit,f_jpg,q_auto/fragaria.cz/posts/PIXNIO-227587-5372x3586_khjell"/> <link rel="apple-touch-icon" sizes="180x180" href="/assets/favicons/apple-touch-icon.png"> <link rel="icon" type="image/png" sizes="32x32" href="/assets/favicons/favicon-32x32.png"> <link rel="icon" type="image/png" sizes="16x16" href="/assets/favicons/favicon-16x16.png"> <link rel="manifest" href="/assets/favicons/site.webmanifest"> <link rel="mask-icon" href="/assets/favicons/safari-pinned-tab.svg" color="#ea272e"> <link rel="shortcut icon" href="/favicon.ico"> <meta name="msapplication-TileColor" content="#ea272e"> <meta name="msapplication-config" content="/assets/favicons/browserconfig.xml"> <meta name="theme-color" content="#ea272e"> <script>
    (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
    (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
    m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
    })(window,document,'script','https://www.google-analytics.com/analytics.js','ga');

    ga('create', 'UA-9784905-1', 'auto');
    ga('send', 'pageview');
</script> <link rel="preload" href="https://res.cloudinary.com/fragaria/raw/upload/v1534234755/fragaria.cz/fonts/AndulkaTextPro.woff" as="font" type="font/woff" crossorigin> <link rel="preload" href="https://res.cloudinary.com/fragaria/raw/upload/v1534234755/fragaria.cz/fonts/AndulkaTextPro-Italic.woff" as="font" type="font/woff" crossorigin> <link rel="preload" href="https://res.cloudinary.com/fragaria/raw/upload/v1534234755/fragaria.cz/fonts/TriviaGroteskN2-Bold.woff" as="font" type="font/woff" crossorigin> <link rel="preload" href="/assets/fonts/fragariacz-icons.ttf?3rxsze" as="font" type="font/ttf" crossorigin="anonymous"> <link rel="preload" href="/assets/js/site.js?fefed86871033f8f71fee69716995b15" as="script"> <link rel="stylesheet" href="/assets/styles.css?d41d8cd98f00b204e9800998ecf8427e"> <link rel="alternate" type="application/atom+xml" href="/feed.xml" title="Blog | Fragaria.cz"/> <link rel="self" type="application/atom+xml" href="/feed.xml"/> <link rel="preload" href="https://fonts.googleapis.com/css?family=Source+Code+Pro" as="style"> <link rel="stylesheet" type="text/css" href="https://cdn.jsdelivr.net/npm/cookieconsent@3/build/cookieconsent.min.css"/> </head> <body class="page-container baseline-grid js-baseline-grid js-ie-warn"> <div class="old-ie-warning"> <img alt="Fragaria s.r.o." src="/assets/img/strawberry.svg"> <h1>Fragaria.cz</h1> <p>We are an <b>agile-thinking</b> company. Following the philosophy, we've decided not to support <b>Internet Explorer</b>. It's just not worth the effort. Since you're using it, you might experience various issues with the site.</p> <p>To see our website in it's full glance, we suggest using <a href="https://www.microsoft.com/en-us/windows/microsoft-edge">Microsoft Edge</a>, <a href="https://www.google.com/chrome/">Google Chrome</a>, <a href="https://www.opera.com/download">Opera</a> or <a href="https://www.mozilla.org/en-US/firefox/new/">Mozilla Firefox</a>.</p> <p><strong>Thanks for your understanding</strong>.</p> <span class="button js-ie-warn__dismiss" role="button">Dismiss</span> </div> <nav id="js-sitenav" class="sitenav js-sitenav" role="navigation" itemscope itemtype="http://schema.org/SiteNavigationElement"> <div class="sitenav__container"> <div class="content-block content-block__cover--mobile"> <div class="sitenav__menu js-sitenav-menu"> <a href="/" class="sitenav__company typeset__anchor--nounderline" itemprop="url"><span itemprop="name">Fragaria</span></a> <a class="sitenav__brand" href="/"> <img alt="Fragaria s.r.o." src="/assets/img/strawberry.svg"> </a> <button class="sitenav__menutoggle hamburger hamburger--collapse js-sitenav-menu__toggle" type="button" aria-label="Menu" aria-controls="js-sitenav" aria-expanded="false"> <span class="hamburger-box"> <span class="hamburger-inner"></span> </span> </button> </div> <ul class="sitenav__linkset"> <li class="sitenav__linkset-item js-sitenav__link"><a href="/#projects" class="sitenav__link typeset__anchor--nounderline js-sitenav-menu__anchor" itemprop="url"><span itemprop="name">Projects</span></a></li> <li class="sitenav__linkset-item js-sitenav__link"><a href="/how-we-work/" class="sitenav__link typeset__anchor--nounderline js-sitenav-menu__anchor" itemprop="url"><span itemprop="name">How we work</span></a></li> <li class="sitenav__linkset-item js-sitenav__link"><a href="/blog/" class="sitenav__link typeset__anchor--nounderline js-sitenav-menu__anchor" itemprop="url"><span itemprop="name">Blog</span></a></li> <li class="sitenav__linkset-item js-sitenav__link"><a href="/work-with-us/" class="sitenav__link typeset__anchor--nounderline js-sitenav-menu__anchor" itemprop="url"><span itemprop="name">Work with us</span></a></li> <li class="sitenav__linkset-item js-sitenav__link"><a href="/#get-in-touch" class="sitenav__link typeset__anchor--nounderline js-sitenav-menu__anchor" itemprop="url"><span itemprop="name">Contact</span></a></li> </ul> </div> </div> </nav> <div class="page-container__inner sitenav-wrapper"> <div class="sitenav-wrapper__push"> <article itemtype="https://schema.org/TechArticle" itemscope class="article" lang="en"> <div class="content-block typeset"> <h1 itemprop="name" class="article__headline">Building a simple company website the Hard Way: Service workers</h1> <meta itemprop="headline" content="Building a simple company website the Hard Way: Service workers"> <div itemprop="publisher" itemtype="http://schema.org/Organization" class="hidden" itemscope> <div itemprop="logo" itemtype="http://schema.org/ImageObject" itemscope=""> <meta itemprop="url" content="https://fragaria.cz/assets/img/strawberry.svg"> </div> <meta itemprop="name" content="Fragaria s.r.o."> </div> <p class="article__meta"> <meta itemprop="datePublished" content=""/> <span class="article__pubdate">April 08, 2019</span> <span itemprop="author" itemtype="http://schema.org/Person" itemscope="" class="article__author"> by <span itemprop="name">Filip Vařecha</span> </span> <meta itemprop="publisher"></meta> </p> <div class="article__content-wrap"> <div class="article__content article-typeset js-auto-add-headline-anchors hypenize"> <p>Hi there once again! I’m gonna close our little <em>Building a simple company website the Hard Way</em> series with a brief introduction to how service workers operate and why you should want them on your website, too. They’re cool and fancy, sometimes unnecessary, but likely still worth your time as I’m about to demonstrate.</p> <figure class="figure content-block__cover--mobile figure--wide"> <img src="https://res.cloudinary.com/fragaria/image/upload/w_1120,c_limit,f_auto,q_auto,dpr_2.0/fragaria.cz/posts/PIXNIO-227587-5372x3586_khjell" srcset="https://res.cloudinary.com/fragaria/image/upload/w_480,c_limit,f_auto,q_auto/fragaria.cz/posts/PIXNIO-227587-5372x3586_khjell 480w, https://res.cloudinary.com/fragaria/image/upload/w_640,c_limit,f_auto,q_auto/fragaria.cz/posts/PIXNIO-227587-5372x3586_khjell 640w, https://res.cloudinary.com/fragaria/image/upload/w_1290,c_limit,f_auto,q_auto/fragaria.cz/posts/PIXNIO-227587-5372x3586_khjell 1290w, https://res.cloudinary.com/fragaria/image/upload/w_1920,c_limit,f_auto,q_auto/fragaria.cz/posts/PIXNIO-227587-5372x3586_khjell 1920w, https://res.cloudinary.com/fragaria/image/upload/w_1120,c_limit,f_auto,q_auto/fragaria.cz/posts/PIXNIO-227587-5372x3586_khjell 1120w, https://res.cloudinary.com/fragaria/image/upload/w_2240,c_limit,f_auto,q_auto/fragaria.cz/posts/PIXNIO-227587-5372x3586_khjell 2240w," class="figure__image js-fix-baseline"/> </figure> <section class="box"> <p>This article is a part of the <i>Building a simple company website the Hard Way</i> series.</p> <ol> <li><a href="/blog/2018/09/03/building-a-simple-company-website-the-hard-way-typography-intro/">Typography introduction</a></li> <li><a href="/blog/2018/11/12/building-a-simple-company-website-the-hard-way-vertical-rhythm/">Vertical rhythm</a></li> <li>Service workers</li> </ol> </section> <p>Service workers are little JavaScript worker scripts that run in the background. Besides their registration, they are completely managed by the browser. Their execution is not limited to the time you directly interact with the related website: <em>they’re kinda alive even if you’re not using the site</em>.</p> <p>As a result, they allow you to do some interesting stuff including:</p> <ul> <li>support offline use of your pages</li> <li>trigger push notifications for new content on your site</li> <li>synchronize cached data for offline use in the background</li> <li>promote addition of home screen link to your page on mobile devices</li> </ul> <p>For the sake of this article, we will focus on offline experience as it’s the most important feature for company portfolio websites.</p> <p>Huge number of content viewers visit your page using their cellphones these days. As a result, your visitors frequently go offline temporarily as mobile networks are generally unrealiable.</p> <h2 id="saving-the-offline-situation">Saving the offline situation</h2> <p>Network connection hanging out in the middle of browsing often results in visitor simply quitting right away. This includes even situations when interruptions are to be expected: like during your descent down to the subway. Service workers can be used to mitigate such risk as they allow you to keep your website functional—albeit just partially—even while the visitor’s network connection is down.</p> <p>How’s that possible? It’s because SW script can act like <em>a network proxy</em>. It can intercept every request the browser makes to the server. This means you can modify the response (either forge one, or use a cached one) and avoid hitting the server completely. You can fill up the caches by pre-loading the content when SW script is being installed. This enables you to make your website blazing fast if you can anticipate next clicks of your users, too.</p> <p>A typical scenario how offline support implementation looks like is following:</p> <ol> <li>Assemble a <strong>list of assets to load automatically</strong> when visitor hits your site. This should include the content that is most likely to be required in near future. It can be anything you can think of: page documents, images, scripts, videos. Anything you want. Just make sure you’re <em>not too greedy</em> about the data transfer. Remember: we do this for mobile devices where extensive data transfer can be costly.</li> <li>Upon service worker installation, <strong>pre-load these assets</strong> and store them in service worker cache.</li> <li>Use service worker to <strong>proxy network requests</strong>. Impose a timeout to load the content from the real server. If the server doesn’t make it on time, offer the cached version instead.</li> <li>If both network and caches fail (e.g. when hitting something that wasn’t pre-loaded), serve some kind of „<em>You’re offline</em>“ page so that the visitor knows what happend. This improves the general user experience.</li> </ol> <h2 id="using-service-workers">Using service workers</h2> <p>It is important to understand the basic lifecycle of a service worker to avoid potiential mistakes. Have a look at following diagram:</p> <figure class="figure content-block__cover--mobile "> <img src="https://res.cloudinary.com/fragaria/image/upload/f_svg/fragaria.cz/posts/sw-lifecycle_t6dh0u" srcset="" class="figure__image js-fix-baseline"/> <figcaption class="figure__caption">Service worker lifecycle.</figcaption> </figure> <p>After you’ve registered the SW, browser will run its installation stage. Next, the SW gets activated and it starts working as our network proxy. It will stay activated until it’s replaced by a new SW script or in case it fails somewhere along the way.</p> <p>Particularly important is the condition when new SW get installed. By definition, this happens when service worker file <em>gets changed</em>. Ultimately, it means new SW is installed once the size of the current SW script is different from the new one—<em>bytewise</em>. Unfortunately, the exact process is little counterintuitive. Old SW is not replaced immediately after new SW is detected, but once the user leaves the page. This means closing it, not just refreshing. Weird? Yes but fortunately fixable. We can avoid default behavior by calling <code class="highlighter-rouge">skipWaiting</code> SW method during the installation as shown below.</p> <p>Still got your attention? Good. Let’s talk code for a moment. I’ll share few examples from this very website.</p> <h3 id="service-worker-registration">Service worker registration</h3> <p>You can initialize your service worker with a simple JS snippet that points the browser to the service worker script. It’s always a good idea to verify your browser supports service workers. All of the modern ones do but someone might still be using an old IE, right?</p> <p>Next, just call <code class="highlighter-rouge">navigator.serviceWorker.register</code> and provide it the path to the worker script itself. In following example, this script is available at <code class="highlighter-rouge">/sw.js</code>.</p> <div class="language-html highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nt">&lt;script </span><span class="na">type=</span><span class="s">"text/javascript"</span><span class="nt">&gt;</span>
<span class="k">if</span> <span class="p">(</span><span class="dl">"</span><span class="s2">serviceWorker</span><span class="dl">"</span> <span class="k">in</span> <span class="nb">navigator</span><span class="p">)</span> <span class="p">{</span>
    <span class="nb">navigator</span><span class="p">.</span><span class="nx">serviceWorker</span><span class="p">.</span><span class="nx">register</span><span class="p">(</span><span class="dl">"</span><span class="s2">/sw.js</span><span class="dl">"</span><span class="p">).</span><span class="nx">then</span><span class="p">(</span><span class="kd">function</span><span class="p">(</span><span class="nx">registration</span><span class="p">)</span> <span class="p">{</span>
        <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="dl">"</span><span class="s2">[sw] Service Worker registration successful with scope: </span><span class="dl">"</span><span class="p">,</span> <span class="nx">registration</span><span class="p">.</span><span class="nx">scope</span><span class="p">);</span>
    <span class="p">}).</span><span class="k">catch</span><span class="p">(</span><span class="kd">function</span><span class="p">(</span><span class="nx">err</span><span class="p">)</span> <span class="p">{</span>
        <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="dl">"</span><span class="s2">[sw] Service Worker registration failed: </span><span class="dl">"</span><span class="p">,</span> <span class="nx">err</span><span class="p">);</span>
    <span class="p">});</span>
<span class="p">}</span>
<span class="nt">&lt;/script&gt;</span>
</code></pre></div></div> <p>Once this snippet is run, registration is finished. Browser takes over and starts the script in the background, proceeding to the installation stage.</p> <h3 id="pre-loading-content">Pre-loading content</h3> <p>Installation stage is there to prepare the SW for its real job. In our case, we want to use it as a network proxy. This is the right time to pre-load our content and fill up the caches. It’s rather straightforward:</p> <div class="language-javascript highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1">// Cache assets</span>
<span class="nx">urls</span><span class="p">.</span><span class="nx">push</span><span class="p">(</span><span class="dl">"</span><span class="s2">/assets/favicons/android-chrome-192x192.png</span><span class="dl">"</span><span class="p">);</span>
<span class="nx">urls</span><span class="p">.</span><span class="nx">push</span><span class="p">(</span><span class="dl">"</span><span class="s2">/assets/favicons/android-chrome-512x512.png</span><span class="dl">"</span><span class="p">);</span>
<span class="nx">urls</span><span class="p">.</span><span class="nx">push</span><span class="p">(</span><span class="dl">"</span><span class="s2">/assets/favicons/apple-touch-icon.png</span><span class="dl">"</span><span class="p">);</span>
<span class="nx">urls</span><span class="p">.</span><span class="nx">push</span><span class="p">(</span><span class="dl">"</span><span class="s2">/assets/favicons/favicon-16x16.png</span><span class="dl">"</span><span class="p">);</span>
<span class="nx">urls</span><span class="p">.</span><span class="nx">push</span><span class="p">(</span><span class="dl">"</span><span class="s2">/assets/favicons/favicon-32x32.png</span><span class="dl">"</span><span class="p">);</span>
<span class="p">...</span>

<span class="c1">// Cache last 10 blog posts</span>
<span class="nx">urls</span><span class="p">.</span><span class="nx">push</span><span class="p">(</span><span class="dl">"</span><span class="s2">/blog/2019/04/05/building-a-simple-company-website-the-hard-way-service-workers/</span><span class="dl">"</span><span class="p">);</span>
<span class="nx">urls</span><span class="p">.</span><span class="nx">push</span><span class="p">(</span><span class="dl">"</span><span class="s2">/blog/2019/03/29/kouzlo-malych-projektu/</span><span class="dl">"</span><span class="p">);</span>
<span class="nx">urls</span><span class="p">.</span><span class="nx">push</span><span class="p">(</span><span class="dl">"</span><span class="s2">/blog/2019/02/05/runtime-configuration-in-web-applications/</span><span class="dl">"</span><span class="p">);</span>
<span class="p">...</span>

<span class="c1">// Cache other pages</span>
<span class="nx">urls</span><span class="p">.</span><span class="nx">push</span><span class="p">(</span><span class="dl">"</span><span class="s2">/404.html</span><span class="dl">"</span><span class="p">);</span>
<span class="nx">urls</span><span class="p">.</span><span class="nx">push</span><span class="p">(</span><span class="dl">"</span><span class="s2">/blog/</span><span class="dl">"</span><span class="p">);</span>
<span class="nx">urls</span><span class="p">.</span><span class="nx">push</span><span class="p">(</span><span class="dl">"</span><span class="s2">/work-with-us/</span><span class="dl">"</span><span class="p">);</span>
<span class="p">...</span>

<span class="c1">// Cache name: adjust version number to invalidate service worker cache.</span>
<span class="kd">const</span> <span class="nx">CACHE_NAME</span> <span class="o">=</span> <span class="dl">'</span><span class="s1">sw-cache-v-1</span><span class="dl">'</span><span class="p">;</span>

<span class="kd">function</span> <span class="nx">precache</span><span class="p">()</span> <span class="p">{</span>
    <span class="nx">caches</span><span class="p">.</span><span class="nx">open</span><span class="p">(</span><span class="nx">CACHE_NAME</span><span class="p">).</span><span class="nx">then</span><span class="p">(</span><span class="kd">function</span><span class="p">(</span><span class="nx">cache</span><span class="p">)</span> <span class="p">{</span>
        <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s2">`[sw] Opened cache </span><span class="p">${</span><span class="nx">CACHE_NAME</span><span class="p">}</span><span class="s2">`</span><span class="p">);</span>
        <span class="k">return</span> <span class="nx">cache</span><span class="p">.</span><span class="nx">addAll</span><span class="p">(</span><span class="nx">urls</span><span class="p">);</span>
    <span class="p">});</span>
<span class="p">}</span>

<span class="nb">self</span><span class="p">.</span><span class="nx">addEventListener</span><span class="p">(</span><span class="dl">'</span><span class="s1">install</span><span class="dl">'</span><span class="p">,</span> <span class="kd">function</span><span class="p">(</span><span class="nx">event</span><span class="p">)</span> <span class="p">{</span>
    <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s2">`[sw] Installing ...`</span><span class="p">);</span>
    <span class="c1">// Make sure not to get stuck waiting for the current to become terminated.</span>
    <span class="nb">self</span><span class="p">.</span><span class="nx">skipWaiting</span><span class="p">();</span>
    <span class="c1">// Perform pre-loading of cached content.</span>
    <span class="nx">event</span><span class="p">.</span><span class="nx">waitUntil</span><span class="p">(</span><span class="nx">precache</span><span class="p">());</span>
<span class="p">});</span>
</code></pre></div></div> <p>Ultimately, we need a list of URLs to pre-load. Cache will contain some critical static assets, last 10 blog posts and few other important pages.</p> <p>Next, we register the handler for the <code class="highlighter-rouge">install</code> event. As a result, <code class="highlighter-rouge">precache</code> is executed which adds all the assets to the SW cache. Caches are automatically available for every SW as the <code class="highlighter-rouge">caches</code> global object and they are clever enough to know how to load URLs. Naturally, this will result in bunch of network requests made by the browser.</p> <p>Before caching starts we also call <code class="highlighter-rouge">self.skipWaiting()</code> method to ensure our new worker gets activated once install is finished. If we didn’t call it, old SW would be replaced <em>after</em> user leaves the page which is not desirable.</p> <p>Please note that <code class="highlighter-rouge">event</code> is promise-aware so we can make it wait for <code class="highlighter-rouge">precache</code> to finish by using <code class="highlighter-rouge">event.waitUntil</code>.</p> <h3 id="network-proxying">Network proxying</h3> <p>When the SW is activated, it can start proxying network requests. This will allow us to make our page work offline. In order to do so, we need to add another handler, this time for <code class="highlighter-rouge">fetch</code> browser event. <code class="highlighter-rouge">fetch</code> is called whenever a request to our server is made by the browser. We can hijack it and make it return cached responses in case server is too slow to respond (which means network is down as our pages are purely static and quick to respond with). Basic script is following:</p> <div class="language-javascript highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">function</span> <span class="nx">storeInCache</span><span class="p">(</span><span class="nx">request</span><span class="p">,</span> <span class="nx">response</span><span class="p">)</span> <span class="p">{</span>
    <span class="nx">caches</span><span class="p">.</span><span class="nx">open</span><span class="p">(</span><span class="nx">CACHE_NAME</span><span class="p">).</span><span class="nx">then</span><span class="p">(</span><span class="nx">cache</span> <span class="o">=&gt;</span> <span class="p">{</span>
        <span class="nx">cache</span><span class="p">.</span><span class="nx">put</span><span class="p">(</span><span class="nx">request</span><span class="p">,</span> <span class="nx">response</span><span class="p">);</span>
    <span class="p">});</span>
<span class="p">}</span>

<span class="kd">function</span> <span class="nx">loadFromNetwork</span><span class="p">(</span><span class="nx">request</span><span class="p">,</span> <span class="nx">timeout</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">return</span> <span class="k">new</span> <span class="nb">Promise</span><span class="p">((</span><span class="nx">fulfill</span><span class="p">,</span> <span class="nx">reject</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="p">{</span>
        <span class="kd">let</span> <span class="nx">tid</span> <span class="o">=</span> <span class="nx">setTimeout</span><span class="p">(</span><span class="nx">reject</span><span class="p">,</span> <span class="nx">timeout</span><span class="p">);</span>

        <span class="nx">fetch</span><span class="p">(</span><span class="nx">request</span><span class="p">).</span><span class="nx">then</span><span class="p">(</span><span class="nx">response</span> <span class="o">=&gt;</span> <span class="p">{</span>
            <span class="nx">clearTimeout</span><span class="p">(</span><span class="nx">tid</span><span class="p">);</span>
            <span class="kd">const</span> <span class="nx">responseClone</span> <span class="o">=</span> <span class="nx">response</span><span class="p">.</span><span class="nx">clone</span><span class="p">();</span>
            <span class="nx">fulfill</span><span class="p">(</span><span class="nx">response</span><span class="p">);</span>
            <span class="nx">storeInCache</span><span class="p">(</span><span class="nx">request</span><span class="p">,</span> <span class="nx">responseClone</span><span class="p">);</span>
        <span class="p">},</span> <span class="nx">reject</span><span class="p">);</span>
    <span class="p">});</span>
<span class="p">}</span>

<span class="kd">function</span> <span class="nx">loadFromCache</span><span class="p">(</span><span class="nx">request</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">return</span> <span class="nx">caches</span><span class="p">.</span><span class="nx">open</span><span class="p">(</span><span class="nx">CACHE_NAME</span><span class="p">).</span><span class="nx">then</span><span class="p">(</span><span class="nx">cache</span> <span class="o">=&gt;</span> <span class="p">{</span>
        <span class="k">return</span> <span class="nx">cache</span><span class="p">.</span><span class="nx">match</span><span class="p">(</span><span class="nx">request</span><span class="p">).</span><span class="nx">then</span><span class="p">(</span><span class="nx">matching</span> <span class="o">=&gt;</span> <span class="p">{</span>
            <span class="k">return</span> <span class="nx">matching</span> <span class="o">||</span> <span class="nb">Promise</span><span class="p">.</span><span class="nx">reject</span><span class="p">(</span><span class="dl">'</span><span class="s1">no-match</span><span class="dl">'</span><span class="p">);</span>
        <span class="p">});</span>
    <span class="p">});</span>
<span class="p">}</span>

<span class="nb">self</span><span class="p">.</span><span class="nx">addEventListener</span><span class="p">(</span><span class="dl">'</span><span class="s1">fetch</span><span class="dl">'</span><span class="p">,</span> <span class="nx">event</span> <span class="o">=&gt;</span> <span class="p">{</span>
    <span class="kd">const</span> <span class="nx">request</span> <span class="o">=</span> <span class="nx">event</span><span class="p">.</span><span class="nx">request</span><span class="p">;</span>
    <span class="kd">let</span> <span class="nx">loadPipe</span> <span class="o">=</span> <span class="nx">loadFromNetwork</span><span class="p">(</span><span class="nx">request</span><span class="p">,</span> <span class="mi">1500</span><span class="p">).</span><span class="k">catch</span><span class="p">(</span><span class="nx">err</span> <span class="o">=&gt;</span> <span class="nx">loadFromCache</span><span class="p">(</span><span class="nx">request</span><span class="p">));</span>
    <span class="nx">event</span><span class="p">.</span><span class="nx">respondWith</span><span class="p">(</span><span class="nx">loadPipe</span><span class="p">);</span>
<span class="p">});</span>
</code></pre></div></div> <p>We impose <em>1500 ms timeout</em> to allow loading resources using the network. If this fails, we provide the cached version in case it’s available.</p> <p>Let’s clean up the fetch handler a little. We do not want to alter the responses for <code class="highlighter-rouge">POST</code> HTTP method. <code class="highlighter-rouge">POST</code> usually means form submission. In that case, it would be unwise to pretend submit succeeded. Let’s intervene only for <code class="highlighter-rouge">GET</code>:</p> <div class="language-javascript highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nb">self</span><span class="p">.</span><span class="nx">addEventListener</span><span class="p">(</span><span class="dl">'</span><span class="s1">fetch</span><span class="dl">'</span><span class="p">,</span> <span class="nx">event</span> <span class="o">=&gt;</span> <span class="p">{</span>
    <span class="kd">const</span> <span class="nx">request</span> <span class="o">=</span> <span class="nx">event</span><span class="p">.</span><span class="nx">request</span><span class="p">;</span>
    <span class="kd">let</span> <span class="nx">loadPipe</span> <span class="o">=</span> <span class="nx">loadFromNetwork</span><span class="p">(</span><span class="nx">request</span><span class="p">,</span> <span class="mi">1500</span><span class="p">).</span><span class="k">catch</span><span class="p">(</span><span class="nx">err</span> <span class="o">=&gt;</span> <span class="nx">loadFromCache</span><span class="p">(</span><span class="nx">request</span><span class="p">));</span>
    <span class="kd">let</span> <span class="nx">handler</span> <span class="o">=</span> <span class="nx">request</span><span class="p">.</span><span class="nx">method</span> <span class="o">===</span> <span class="dl">'</span><span class="s1">GET</span><span class="dl">'</span> <span class="p">?</span> <span class="nx">loadPipe</span> <span class="p">:</span> <span class="nx">fetch</span><span class="p">(</span><span class="nx">request</span><span class="p">);</span>
    <span class="k">return</span> <span class="nx">event</span><span class="p">.</span><span class="nx">respondWith</span><span class="p">(</span><span class="nx">handler</span><span class="p">)</span>
<span class="p">});</span>
</code></pre></div></div> <h3 id="offline-pages">Offline pages</h3> <p>In order to show user a nice offline page, we gotta improve our <code class="highlighter-rouge">loadPipe</code> pipeline. Specifically, we need to handle the case when cached version of the page is <em>unavailable</em>:</p> <div class="language-javascript highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nb">self</span><span class="p">.</span><span class="nx">addEventListener</span><span class="p">(</span><span class="dl">'</span><span class="s1">fetch</span><span class="dl">'</span><span class="p">,</span> <span class="nx">event</span> <span class="o">=&gt;</span> <span class="p">{</span>
    <span class="kd">const</span> <span class="nx">request</span> <span class="o">=</span> <span class="nx">event</span><span class="p">.</span><span class="nx">request</span><span class="p">;</span>
    <span class="kd">let</span> <span class="nx">handler</span> <span class="o">=</span> <span class="kc">null</span><span class="p">;</span>

    <span class="k">if</span> <span class="p">(</span><span class="nx">request</span><span class="p">.</span><span class="nx">method</span> <span class="o">===</span> <span class="dl">'</span><span class="s1">GET</span><span class="dl">'</span><span class="p">)</span> <span class="p">{</span>
        <span class="nx">handler</span> <span class="o">=</span> <span class="nx">loadFromNetwork</span><span class="p">(</span><span class="nx">request</span><span class="p">,</span> <span class="mi">1500</span><span class="p">)</span>
            <span class="p">.</span><span class="k">catch</span><span class="p">(</span><span class="nx">err</span> <span class="o">=&gt;</span> <span class="nx">loadFromCache</span><span class="p">(</span><span class="nx">request</span><span class="p">))</span>
            <span class="p">.</span><span class="k">catch</span><span class="p">(</span><span class="nx">err</span> <span class="o">=&gt;</span> <span class="p">{</span>
                <span class="nx">console</span><span class="p">.</span><span class="nx">warn</span><span class="p">(</span><span class="dl">'</span><span class="s1">[sw] Could not load, redirecting to offline page </span><span class="dl">'</span><span class="p">,</span> <span class="nx">err</span><span class="p">);</span>
                <span class="k">return</span> <span class="nx">caches</span><span class="p">.</span><span class="nx">open</span><span class="p">(</span><span class="nx">CACHE_NAME</span><span class="p">).</span><span class="nx">then</span><span class="p">(</span><span class="nx">cache</span> <span class="o">=&gt;</span> <span class="p">{</span>
                    <span class="k">return</span> <span class="nx">cache</span><span class="p">.</span><span class="nx">match</span><span class="p">(</span><span class="dl">'</span><span class="s1">/offline/</span><span class="dl">'</span><span class="p">);</span>
                <span class="p">})</span>
            <span class="p">});</span>
    <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
        <span class="nx">handler</span> <span class="o">=</span> <span class="nx">fetch</span><span class="p">(</span><span class="nx">request</span><span class="p">);</span>
    <span class="p">}</span>

    <span class="k">return</span> <span class="nx">event</span><span class="p">.</span><span class="nx">respondWith</span><span class="p">(</span><span class="nx">handler</span><span class="p">);</span>
<span class="p">});</span>
</code></pre></div></div> <p><code class="highlighter-rouge">/offline/</code> should always be in the cache as we’ve added it to the cache during installation stage.</p> <h2 id="homescreen-link-to-your-page">Homescreen link to your page</h2> <p>Another nice benefit of implementing a service worker is ability to prompt your visitors to add a website shortcut on their phone homescreens. It will look just like any other mobile application launch button and open in a webview automatically. It’s a first step towards making your website work like a <em>Progressive Web App</em>. You need to meet a few more requirements though:</p> <ul> <li>Your page has to be <em>served using HTTPS</em>. But you do that already anyway, don’t you?</li> <li>You need to <em>prepare the icon</em> for the app shortcut. Usually, your site logo will do just fine.</li> <li>You have to provide a <em>manifest file</em>. The easiest way to create it is using some online generator, like <a href="https://app-manifest.firebaseapp.com/">this one</a>.</li> </ul> <p>Once you’ve accomplished all of these tasks and have a working SW, Chrome will prompt visitors to add shortcut automatically.</p> <figure class="figure content-block__cover--mobile "> <img src="https://res.cloudinary.com/fragaria/image/upload/w_640,c_limit,f_auto,q_auto,dpr_2.0/fragaria.cz/posts/Screenshot_2019-04-07-14-23-47-738_com.android.chrome_q0rwob" srcset="https://res.cloudinary.com/fragaria/image/upload/w_480,c_limit,f_auto,q_auto/fragaria.cz/posts/Screenshot_2019-04-07-14-23-47-738_com.android.chrome_q0rwob 480w, https://res.cloudinary.com/fragaria/image/upload/w_640,c_limit,f_auto,q_auto/fragaria.cz/posts/Screenshot_2019-04-07-14-23-47-738_com.android.chrome_q0rwob 640w, https://res.cloudinary.com/fragaria/image/upload/w_1290,c_limit,f_auto,q_auto/fragaria.cz/posts/Screenshot_2019-04-07-14-23-47-738_com.android.chrome_q0rwob 1290w, https://res.cloudinary.com/fragaria/image/upload/w_1920,c_limit,f_auto,q_auto/fragaria.cz/posts/Screenshot_2019-04-07-14-23-47-738_com.android.chrome_q0rwob 1920w, https://res.cloudinary.com/fragaria/image/upload/w_1120,c_limit,f_auto,q_auto/fragaria.cz/posts/Screenshot_2019-04-07-14-23-47-738_com.android.chrome_q0rwob 1120w, https://res.cloudinary.com/fragaria/image/upload/w_2240,c_limit,f_auto,q_auto/fragaria.cz/posts/Screenshot_2019-04-07-14-23-47-738_com.android.chrome_q0rwob 2240w," class="figure__image js-fix-baseline"/> <figcaption class="figure__caption">Google Chrome suggests adding a home screen shortcut.</figcaption> </figure> <h2 id="conclusions">Conclusions</h2> <p>In a brief example, we’ve demonstrated how you can use service workers to improve the overall user experience—especially on mobile devices. In a real world scenario, we would need to add a few more moving parts like syncing up the caches in the background (when new content comes up) but hopefully we’ve at least gave you a little headstart. <em>Progessive Web Apps</em> are way to go these days and running a service worker is one of key requirements to make your app a progressive one.</p> </div> </div> </div> <div class="content-block"> <div class="article__misc"> <div class="article__miscitem"> <div class="taglist " itemscope itemtype="http://schema.org/WebPage"> <a class="taglist__tag anchor anchor--emphasized" href="/blog/archive/tag/javascript/" itemprop="relatedLink">javascript, </a> <a class="taglist__tag anchor anchor--emphasized" href="/blog/archive/tag/service-workers/" itemprop="relatedLink">service workers, </a> <a class="taglist__tag anchor anchor--emphasized" href="/blog/archive/tag/progressive-web-apps/" itemprop="relatedLink">progressive web apps</a> </div> </div> <div class="article__miscitem"> <div class="sharebox"> <ul class="sharebox__items"> <li class="sharebox__item sharebox__item--twitter"> <a class="sharebox__item-body" href="https://twitter.com/intent/tweet?text=Building a simple company website the Hard Way: Service workers&url=https://fragaria.cz/blog/2019/04/08/building-a-simple-company-website-the-hard-way-service-workers/&via=&related=" target="_blank" rel="noopener" title="Share on Twitter"><span>Share on Twitter</span></a> </li> <li class="sharebox__item sharebox__item--facebook"> <a class="sharebox__item-body" href="https://facebook.com/sharer.php?u=https://fragaria.cz/blog/2019/04/08/building-a-simple-company-website-the-hard-way-service-workers/" target="_blank" rel="noopener" title="Share on Facebook"><span>Share on Facebook</span></a> </li> </ul> </div> </div> </div> </div> </article> <footer class="content-block"> <div class="footer"> <div class="footer__meta"> <a href="/"> <img alt="Fragaria s.r.o." class="footer__brand" src="/assets/img/strawberry.svg"> </a> <div class="footer__copy"> <div class="footer__copy-line footer__copy-line--emphasized">FRAGARIA &copy; 2023</div> <div class="footer__copy-line">Talk is cheap, show me the code.</div> </div> </div> <div class="footer__social"> <a href="https://www.youtube.com/channel/UCz1zwJ9_6-IVdX6oCvq6T_g" class="icon--youtube footer__social-icon" title="Youtube channel"></a> <a href="https://twitter.com/fragariacz" class="icon--twitter footer__social-icon" title="Twitter profile page"></a> <a href="https://linkedin.com/company/fragaria-ltd" class="icon--linkedin footer__social-icon" title="LinkedIn profile page"></a> <a href="https://github.com/fragaria" class="icon--github footer__social-icon" title="GitHub profile page"></a> <a href="https://stackshare.io/fragaria" class="icon--stackshare footer__social-icon" title="Stackshare profile page"></a> </div> </div> </footer> </div> </div> <script src="https://cdn.jsdelivr.net/npm/cookieconsent@3/build/cookieconsent.min.js" data-cfasync="false"></script> <script src="/assets/js/smoothscroll.js"></script> <script src="/assets/js/element-closest.js"></script> <script src="/assets/js/site.js?fefed86871033f8f71fee69716995b15"></script> <script type="text/javascript" src="/assets/js/register-sw.js"></script> </body> </html>