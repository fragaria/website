<!DOCTYPE html> <html lang="en" dir="ltr" itemtype="http://schema.org/WebPage" itemscope=""> <head> <meta charset="utf-8"> <meta http-equiv="X-UA-Compatible" content="IE=edge"> <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no"> <meta name="HandheldFriendly" content="true"/> <title>Jahoda, malina, sloni, hadi, flanděra, angular | Fragaria.cz</title> <meta name="author" content="Fragaria s.r.o."/> <meta name="robots" content="index,follow"/> <meta name="description" content="Přijde takhle klient do kanceláře a povídá: Máme tady takovou velkou mašinu a k ní si můžeme koupit příšerně drahý ovládací panel. Nesvedli byste pro nás udělat něco levnějšího? Technicky zdatný ředitel společnosti nesměle dí: To bychom asi svedli. Klientovi se rozzáří očka a tichým hlasem dodá: Ale potřebovali bychom, aby to..."> <meta name="keywords" content="software, software development, web apps, vývoj software, webové aplikace, python, javascript, typescript, java, angular, vue, elasticsearch, html, css, sqlite, javascript, python, flask, angular, socket.io, eventlet, postgresql, raspberry, rest"/> <meta property="og:url" content="https://fragaria.cz/blog/2017/07/03/jahoda-malina-sloni-hadi-flandera/"/> <meta property="og:type" content="website"/> <meta property="og:title" content="Jahoda, malina, sloni, hadi, flanděra, angular | Fragaria.cz"/> <meta property="og:description" content="Přijde takhle klient do kanceláře a povídá: Máme tady takovou velkou mašinu a k ní si můžeme koupit příšerně drahý ovládací panel. Nesvedli byste pro nás udělat něco levnějšího? Technicky zdatný ředitel společnosti nesměle dí: To bychom asi svedli. Klientovi se rozzáří očka a tichým hlasem dodá: Ale potřebovali bychom, aby to..."/> <meta property="og:image" content="https://res.cloudinary.com/fragaria/image/upload/w_640,c_fit,f_jpg,q_auto/fragaria.cz/posts/2017-07-03-jahoda-malina-sloni-hadi-flandera__1.jpg"/> <link rel="apple-touch-icon" sizes="180x180" href="/assets/favicons/apple-touch-icon.png"> <link rel="icon" type="image/png" sizes="32x32" href="/assets/favicons/favicon-32x32.png"> <link rel="icon" type="image/png" sizes="16x16" href="/assets/favicons/favicon-16x16.png"> <link rel="manifest" href="/assets/favicons/site.webmanifest"> <link rel="mask-icon" href="/assets/favicons/safari-pinned-tab.svg" color="#ea272e"> <link rel="shortcut icon" href="/favicon.ico"> <meta name="msapplication-TileColor" content="#ea272e"> <meta name="msapplication-config" content="/assets/favicons/browserconfig.xml"> <meta name="theme-color" content="#ea272e"> <script>
    (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
    (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
    m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
    })(window,document,'script','https://www.google-analytics.com/analytics.js','ga');

    ga('create', 'UA-9784905-1', 'auto');
    ga('send', 'pageview');
</script> <link rel="preload" href="https://res.cloudinary.com/fragaria/raw/upload/v1534234755/fragaria.cz/fonts/AndulkaTextPro.woff" as="font" type="font/woff" crossorigin> <link rel="preload" href="https://res.cloudinary.com/fragaria/raw/upload/v1534234755/fragaria.cz/fonts/AndulkaTextPro-Italic.woff" as="font" type="font/woff" crossorigin> <link rel="preload" href="https://res.cloudinary.com/fragaria/raw/upload/v1534234755/fragaria.cz/fonts/TriviaGroteskN2-Bold.woff" as="font" type="font/woff" crossorigin> <link rel="preload" href="/assets/fonts/fragariacz-icons.ttf?3rxsze" as="font" type="font/ttf" crossorigin="anonymous"> <link rel="preload" href="/assets/js/site.js?906be5e74733e0c75a9b8bc048028f1f" as="script"> <link rel="stylesheet" href="/assets/styles.css?d41d8cd98f00b204e9800998ecf8427e"> <link rel="alternate" type="application/atom+xml" href="/feed.xml" title="Blog | Fragaria.cz"/> <link rel="self" type="application/atom+xml" href="/feed.xml"/> <link rel="preload" href="https://fonts.googleapis.com/css?family=Source+Code+Pro" as="style"> <link rel="stylesheet" type="text/css" href="https://cdn.jsdelivr.net/npm/cookieconsent@3/build/cookieconsent.min.css"/> </head> <body class="page-container baseline-grid js-baseline-grid js-ie-warn"> <div class="old-ie-warning"> <img alt="Fragaria s.r.o." src="/assets/img/strawberry.svg"> <h1>Fragaria.cz</h1> <p>We are an <b>agile-thinking</b> company. Following the philosophy, we've decided not to support <b>Internet Explorer</b>. It's just not worth the effort. Since you're using it, you might experience various issues with the site.</p> <p>To see our website in it's full glance, we suggest using <a href="https://www.microsoft.com/en-us/windows/microsoft-edge">Microsoft Edge</a>, <a href="https://www.google.com/chrome/">Google Chrome</a>, <a href="https://www.opera.com/download">Opera</a> or <a href="https://www.mozilla.org/en-US/firefox/new/">Mozilla Firefox</a>.</p> <p><strong>Thanks for your understanding</strong>.</p> <span class="button js-ie-warn__dismiss" role="button">Dismiss</span> </div> <nav id="js-sitenav" class="sitenav js-sitenav" role="navigation" itemscope itemtype="http://schema.org/SiteNavigationElement"> <div class="sitenav__container"> <div class="content-block content-block__cover--mobile"> <div class="sitenav__menu js-sitenav-menu"> <a href="/" class="sitenav__company typeset__anchor--nounderline" itemprop="url"><span itemprop="name">Fragaria</span></a> <a class="sitenav__brand" href="/"> <img alt="Fragaria s.r.o." src="/assets/img/strawberry.svg"> </a> <button class="sitenav__menutoggle hamburger hamburger--collapse js-sitenav-menu__toggle" type="button" aria-label="Menu" aria-controls="js-sitenav" aria-expanded="false"> <span class="hamburger-box"> <span class="hamburger-inner"></span> </span> </button> </div> <ul class="sitenav__linkset"> <li class="sitenav__linkset-item js-sitenav__link"><a href="/#projects" class="sitenav__link typeset__anchor--nounderline js-sitenav-menu__anchor" itemprop="url"><span itemprop="name">Projects</span></a></li> <li class="sitenav__linkset-item js-sitenav__link"><a href="/solutions/" class="sitenav__link typeset__anchor--nounderline js-sitenav-menu__anchor" itemprop="url"><span itemprop="name">Solutions</span></a></li> <li class="sitenav__linkset-item js-sitenav__link"><a href="/blog/" class="sitenav__link typeset__anchor--nounderline js-sitenav-menu__anchor" itemprop="url"><span itemprop="name">Blog</span></a></li> <li class="sitenav__linkset-item js-sitenav__link"><a href="/work-with-us/" class="sitenav__link typeset__anchor--nounderline js-sitenav-menu__anchor" itemprop="url"><span itemprop="name">Work with us</span></a></li> <li class="sitenav__linkset-item js-sitenav__link"><a href="/#get-in-touch" class="sitenav__link typeset__anchor--nounderline js-sitenav-menu__anchor" itemprop="url"><span itemprop="name">Contact</span></a></li> </ul> </div> </div> </nav> <div class="page-container__inner sitenav-wrapper"> <div class="sitenav-wrapper__push"> <article itemtype="https://schema.org/TechArticle" itemscope class="article" lang="cs"> <div class="content-block typeset"> <h1 itemprop="name" class="article__headline">Jahoda, malina, sloni, hadi, flanděra, angular</h1> <meta itemprop="headline" content="Jahoda, malina, sloni, hadi, flanděra, angular"> <div itemprop="publisher" itemtype="http://schema.org/Organization" class="hidden" itemscope> <div itemprop="logo" itemtype="http://schema.org/ImageObject" itemscope=""> <meta itemprop="url" content="https://fragaria.cz/assets/img/strawberry.svg"> </div> <meta itemprop="name" content="Fragaria s.r.o."> </div> <p class="article__meta"> <meta itemprop="datePublished" content=""/> <span class="article__pubdate">July 03, 2017</span> <span itemprop="author" itemtype="http://schema.org/Person" itemscope="" class="article__author"> by <span itemprop="name">Jirka Chadima</span> </span> <meta itemprop="publisher"></meta> </p> <div class="article__content-wrap"> <div class="article__content article-typeset js-auto-add-headline-anchors hypenize"> <p>Přijde takhle klient do kanceláře a povídá: <em><q>Máme tady takovou velkou mašinu a k ní si můžeme koupit příšerně drahý ovládací panel. Nesvedli byste pro nás udělat něco levnějšího?</q></em> Technicky zdatný ředitel společnosti nesměle dí: <em><q>To bychom asi svedli.</q></em> Klientovi se rozzáří očka a tichým hlasem dodá: <em><q>Ale potřebovali bychom, aby to fungovalo ve skoro reálném čase a máme tu na to nějaká volná Raspberry Pi.</q></em></p> <p>Kromě výkonnosti Raspberry jsme také podle zadání docela omezeni v technologickém rozletu: nějaký ten webový frontend, kde se budou data ukazovat a bude je možné měnit, backend ideálně v Pythonu a jako datové úložiště bychom rádi použili třeba SQLite. Naše vyprávění ale začneme od uživatelského konce, tedy od klienta.</p> <figure class="figure content-block__cover--mobile "> <img src="https://res.cloudinary.com/fragaria/image/upload/w_640,c_limit,f_auto,q_auto,dpr_2.0/fragaria.cz/posts/2017-07-03-jahoda-malina-sloni-hadi-flandera__1.jpg" srcset="https://res.cloudinary.com/fragaria/image/upload/w_480,c_limit,f_auto,q_auto/fragaria.cz/posts/2017-07-03-jahoda-malina-sloni-hadi-flandera__1.jpg 480w, https://res.cloudinary.com/fragaria/image/upload/w_640,c_limit,f_auto,q_auto/fragaria.cz/posts/2017-07-03-jahoda-malina-sloni-hadi-flandera__1.jpg 640w, https://res.cloudinary.com/fragaria/image/upload/w_1290,c_limit,f_auto,q_auto/fragaria.cz/posts/2017-07-03-jahoda-malina-sloni-hadi-flandera__1.jpg 1290w, https://res.cloudinary.com/fragaria/image/upload/w_1920,c_limit,f_auto,q_auto/fragaria.cz/posts/2017-07-03-jahoda-malina-sloni-hadi-flandera__1.jpg 1920w, https://res.cloudinary.com/fragaria/image/upload/w_1120,c_limit,f_auto,q_auto/fragaria.cz/posts/2017-07-03-jahoda-malina-sloni-hadi-flandera__1.jpg 1120w, https://res.cloudinary.com/fragaria/image/upload/w_2240,c_limit,f_auto,q_auto/fragaria.cz/posts/2017-07-03-jahoda-malina-sloni-hadi-flandera__1.jpg 2240w," class="figure__image js-fix-baseline"/> </figure> <h2 id="angular-websockets-a-socketio">Angular, WebSockets a socket.io</h2> <p>Protože ve Fragarii válíme poslední dobou hlavně v Angularu, tak jsme použili jeho čtvrtou, poslední verzi a místo tradičního pollingu se jako komunikační protokol přímo nabízí <a href="https://en.wikipedia.org/wiki/WebSocket">WebSockets</a>. Kdo by neznal, představí si otevřený tunel mezi prohlížečem a serverem, kudy obousměrně tečou data. Oproti tradičnímu HTTP, zásadním způsobem eliminujeme režii spojenou s každým novým požadavkem a tím zvyšujeme výkon celé aplikace.</p> <p>Jenže! Jak se později ukázalo, v Pythonu je jednodušší použít knihovnu <a href="https://socket.io/">socket.io</a>, která umí kromě WebSocketů spousta dalších parádních věcí - zejména se tvářit jako WebSockets i tam, kde tahle technologie nefunguje a taky jednotlivým datovým zprávám přiřazovat pojmenovaný typ.</p> <p>Takže si v Angularu podobně jako v <a href="https://www.npmjs.com/package/ng2-socket-io">tomhle návodu</a> napíšeme tupoučký wrapper a službičku…</p> <figure class="highlight"><pre><code class="language-javascript" data-lang="javascript"><span class="c1">// .. omit some imports</span>
<span class="p">@</span><span class="nd">Injectable</span><span class="p">()</span>
<span class="k">export</span> <span class="kd">class</span> <span class="nx">WebSocketService</span> <span class="p">{</span>
    <span class="kr">private</span> <span class="nx">sockets</span><span class="p">:</span> <span class="p">{[</span><span class="nx">name</span><span class="p">:</span> <span class="nx">string</span><span class="p">]:</span> <span class="nx">WrappedSocket</span><span class="p">}</span> <span class="o">=</span> <span class="p">{};</span>

    <span class="kr">public</span> <span class="nx">connect</span><span class="p">(</span><span class="nx">url</span><span class="p">:</span> <span class="nx">string</span><span class="p">,</span> <span class="nx">options</span><span class="p">?:</span> <span class="nx">any</span><span class="p">):</span> <span class="nx">WrappedSocket</span> <span class="p">{</span>
        <span class="k">if</span> <span class="p">(</span><span class="o">!</span> <span class="k">this</span><span class="p">.</span><span class="nx">sockets</span><span class="p">[</span><span class="nx">url</span><span class="p">])</span> <span class="p">{</span>
            <span class="k">this</span><span class="p">.</span><span class="nx">sockets</span><span class="p">[</span><span class="nx">url</span><span class="p">]</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">WrappedSocket</span><span class="p">({</span><span class="na">url</span><span class="p">:</span> <span class="nx">url</span><span class="p">,</span> <span class="na">options</span><span class="p">:</span> <span class="nx">options</span><span class="p">});</span>
        <span class="p">}</span>
        <span class="k">return</span> <span class="k">this</span><span class="p">.</span><span class="nx">sockets</span><span class="p">[</span><span class="nx">url</span><span class="p">];</span>
    <span class="p">}</span>
<span class="p">}</span></code></pre></figure> <figure class="highlight"><pre><code class="language-javascript" data-lang="javascript"><span class="c1">// omit import, basically taken from ng2-socket-io</span>
<span class="k">import</span> <span class="o">*</span> <span class="k">as</span> <span class="nx">io</span> <span class="k">from</span> <span class="dl">'</span><span class="s1">socket.io-client</span><span class="dl">'</span><span class="p">;</span>

<span class="p">@</span><span class="nd">Injectable</span><span class="p">()</span>
<span class="k">export</span> <span class="kd">class</span> <span class="nx">WrappedSocket</span> <span class="p">{</span>
    <span class="nl">ioSocket</span><span class="p">:</span> <span class="nx">any</span><span class="p">;</span>

    <span class="kd">constructor</span><span class="p">(</span><span class="nx">config</span><span class="p">:</span> <span class="nx">SocketIoConfig</span><span class="p">)</span> <span class="p">{</span>
        <span class="kd">const</span> <span class="nx">url</span><span class="p">:</span> <span class="nx">string</span> <span class="o">=</span> <span class="nx">config</span><span class="p">.</span><span class="nx">url</span> <span class="o">||</span> <span class="dl">''</span><span class="p">;</span>
        <span class="kd">const</span> <span class="nx">options</span><span class="p">:</span> <span class="nx">any</span> <span class="o">=</span> <span class="nx">config</span><span class="p">.</span><span class="nx">options</span> <span class="o">||</span> <span class="p">{};</span>
        <span class="k">this</span><span class="p">.</span><span class="nx">ioSocket</span> <span class="o">=</span> <span class="nx">io</span><span class="p">(</span><span class="nx">url</span><span class="p">,</span> <span class="nx">options</span><span class="p">);</span>
    <span class="p">}</span>

    <span class="nx">on</span><span class="p">(</span><span class="nx">eventName</span><span class="p">:</span> <span class="nx">string</span><span class="p">,</span> <span class="nx">callback</span><span class="p">:</span> <span class="nb">Function</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">this</span><span class="p">.</span><span class="nx">ioSocket</span><span class="p">.</span><span class="nx">on</span><span class="p">(</span><span class="nx">eventName</span><span class="p">,</span> <span class="nx">callback</span><span class="p">);</span>
    <span class="p">}</span>

    <span class="nx">once</span><span class="p">(</span><span class="nx">eventName</span><span class="p">:</span> <span class="nx">string</span><span class="p">,</span> <span class="nx">callback</span><span class="p">:</span> <span class="nb">Function</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">this</span><span class="p">.</span><span class="nx">ioSocket</span><span class="p">.</span><span class="nx">once</span><span class="p">(</span><span class="nx">eventName</span><span class="p">,</span> <span class="nx">callback</span><span class="p">);</span>
    <span class="p">}</span>

    <span class="nx">connect</span><span class="p">()</span> <span class="p">{</span>
        <span class="k">return</span> <span class="k">this</span><span class="p">.</span><span class="nx">ioSocket</span><span class="p">.</span><span class="nx">connect</span><span class="p">();</span>
    <span class="p">}</span>

    <span class="nx">disconnect</span><span class="p">(</span><span class="nx">close</span><span class="p">?:</span> <span class="nx">any</span><span class="p">)</span> <span class="p">{</span>
        <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="dl">'</span><span class="s1">disconnect</span><span class="dl">'</span><span class="p">)</span>
        <span class="k">return</span> <span class="k">this</span><span class="p">.</span><span class="nx">ioSocket</span><span class="p">.</span><span class="nx">disconnect</span><span class="p">.</span><span class="nx">apply</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">ioSocket</span><span class="p">,</span> <span class="nx">arguments</span><span class="p">);</span>
    <span class="p">}</span>

    <span class="nx">emit</span><span class="p">(</span><span class="nx">eventName</span><span class="p">:</span> <span class="nx">string</span><span class="p">,</span> <span class="nx">data</span><span class="p">:</span> <span class="nx">any</span><span class="p">,</span> <span class="nx">callback</span><span class="p">?:</span> <span class="nb">Function</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">return</span> <span class="k">this</span><span class="p">.</span><span class="nx">ioSocket</span><span class="p">.</span><span class="nx">emit</span><span class="p">.</span><span class="nx">apply</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">ioSocket</span><span class="p">,</span> <span class="nx">arguments</span><span class="p">);</span>
    <span class="p">}</span>

    <span class="nx">removeListener</span><span class="p">(</span><span class="nx">eventName</span><span class="p">:</span> <span class="nx">string</span><span class="p">,</span> <span class="nx">callback</span><span class="p">?:</span> <span class="nb">Function</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">return</span> <span class="k">this</span><span class="p">.</span><span class="nx">ioSocket</span><span class="p">.</span><span class="nx">removeListener</span><span class="p">.</span><span class="nx">apply</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">ioSocket</span><span class="p">,</span> <span class="nx">arguments</span><span class="p">);</span>
    <span class="p">}</span>

    <span class="nx">removeAllListeners</span><span class="p">(</span><span class="nx">eventName</span><span class="p">?:</span> <span class="nx">string</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">return</span> <span class="k">this</span><span class="p">.</span><span class="nx">ioSocket</span><span class="p">.</span><span class="nx">removeAllListeners</span><span class="p">.</span><span class="nx">apply</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">ioSocket</span><span class="p">,</span> <span class="nx">arguments</span><span class="p">);</span>
    <span class="p">}</span>

    <span class="cm">/** create an Observable from an event */</span>
    <span class="nx">fromEvent</span><span class="o">&lt;</span><span class="nx">T</span><span class="o">&gt;</span><span class="p">(</span><span class="nx">eventName</span><span class="p">:</span> <span class="nx">string</span><span class="p">):</span> <span class="nx">Observable</span><span class="o">&lt;</span><span class="nx">T</span><span class="o">&gt;</span> <span class="p">{</span>
        <span class="k">this</span><span class="p">.</span><span class="nx">subscribersCounter</span><span class="o">++</span><span class="p">;</span>
        <span class="k">return</span> <span class="nx">Observable</span><span class="p">.</span><span class="nx">create</span><span class="p">(</span> <span class="p">(</span><span class="na">observer</span><span class="p">:</span> <span class="nx">any</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="p">{</span>
             <span class="k">this</span><span class="p">.</span><span class="nx">ioSocket</span><span class="p">.</span><span class="nx">on</span><span class="p">(</span><span class="nx">eventName</span><span class="p">,</span> <span class="p">(</span><span class="na">data</span><span class="p">:</span> <span class="nx">T</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="p">{</span>
                 <span class="nx">observer</span><span class="p">.</span><span class="nx">next</span><span class="p">(</span><span class="nx">data</span><span class="p">);</span>
             <span class="p">});</span>
             <span class="k">return</span> <span class="p">()</span> <span class="o">=&gt;</span> <span class="p">{</span>
                 <span class="k">if</span> <span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">subscribersCounter</span> <span class="o">===</span> <span class="mi">1</span><span class="p">)</span>
                    <span class="k">this</span><span class="p">.</span><span class="nx">ioSocket</span><span class="p">.</span><span class="nx">removeListener</span><span class="p">(</span><span class="nx">eventName</span><span class="p">);</span>
            <span class="p">};</span>
        <span class="p">}).</span><span class="nx">share</span><span class="p">();</span>
    <span class="p">}</span>
<span class="p">}</span></code></pre></figure> <p>…a na dalších 20 řádkách si ten tunel ještě pustíme. No, a to je vlastně všechno. Zbytek aplikace jsou tradiční nezajímavé formulářové inputy, validace a taky on-screen klávesnice. Třeba trochu upravená <a href="https://github.com/protacon/ng-virtual-keyboard">tahleta</a>.</p> <figure class="highlight"><pre><code class="language-javascript" data-lang="javascript"><span class="c1">// omit imports</span>
<span class="kd">const</span>   <span class="nx">SOCKET_URL</span> <span class="o">=</span> <span class="dl">'</span><span class="s1">/* @echo SOCKET_URL */</span><span class="dl">'</span><span class="p">;</span>

<span class="p">@</span><span class="nd">Component</span><span class="p">({</span>
    <span class="na">templateUrl</span><span class="p">:</span> <span class="dl">'</span><span class="s1">dashboard.component.html</span><span class="dl">'</span><span class="p">,</span>
    <span class="na">styleUrls</span><span class="p">:</span> <span class="p">[</span><span class="dl">'</span><span class="s1">dashboard.component.less</span><span class="dl">'</span><span class="p">]</span>
<span class="p">})</span>
<span class="k">export</span> <span class="kd">class</span> <span class="nx">Dashboard</span> <span class="kr">implements</span> <span class="nx">OnInit</span><span class="p">,</span> <span class="nx">OnDestroy</span> <span class="p">{</span>

    <span class="kr">public</span> <span class="nx">mainSocket</span><span class="p">:</span> <span class="nx">WrappedSocket</span><span class="p">;</span>
    <span class="nx">socketSubscribe</span><span class="p">;</span>
    <span class="nx">fields</span> <span class="o">=</span> <span class="p">{};</span>

    <span class="kd">constructor</span> <span class="p">(</span>
        <span class="kr">private</span> <span class="nx">socketService</span><span class="p">:</span> <span class="nx">WebSocketService</span>
    <span class="p">)</span> <span class="p">{</span>
        <span class="k">this</span><span class="p">.</span><span class="nx">mainSocket</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">socketService</span>
            <span class="p">.</span><span class="nx">connect</span><span class="p">(</span><span class="nx">SOCKET_URL</span><span class="p">);</span>
    <span class="p">}</span>

    <span class="nx">ngOnInit</span><span class="p">()</span> <span class="p">{</span>
        <span class="c1">// Listen for "data_changed" events from server</span>
        <span class="k">this</span><span class="p">.</span><span class="nx">socketSubscribe</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">mainSocket</span>
            <span class="p">.</span><span class="nx">fromEvent</span><span class="o">&lt;</span><span class="nx">any</span><span class="o">&gt;</span><span class="p">(</span><span class="dl">'</span><span class="s1">data_changed</span><span class="dl">'</span><span class="p">)</span>
            <span class="p">.</span><span class="nx">subscribe</span><span class="p">((</span><span class="nx">response</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="p">{</span>
                <span class="kd">let</span> <span class="nx">data</span> <span class="o">=</span> <span class="nx">response</span><span class="p">.</span><span class="nx">data</span><span class="p">;</span>
                <span class="k">if</span> <span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">fields</span><span class="p">[</span><span class="nx">data</span><span class="p">.</span><span class="nx">name</span><span class="p">])</span> <span class="p">{</span>
                    <span class="kd">let</span> <span class="nx">field</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">fields</span><span class="p">[</span><span class="nx">data</span><span class="p">.</span><span class="nx">name</span><span class="p">];</span>
                    <span class="nx">field</span><span class="p">.</span><span class="nx">value</span> <span class="o">=</span> <span class="nx">field</span><span class="p">.</span><span class="nx">modify</span> <span class="p">?</span> <span class="nx">field</span><span class="p">.</span><span class="nx">modify</span><span class="p">(</span><span class="nx">data</span><span class="p">.</span><span class="nx">value</span><span class="p">)</span> <span class="p">:</span> <span class="nb">Number</span><span class="p">.</span><span class="nb">parseInt</span><span class="p">(</span><span class="nx">data</span><span class="p">.</span><span class="nx">value</span><span class="p">,</span> <span class="mi">10</span><span class="p">);</span>
                <span class="p">}</span>
            <span class="p">});</span>
    <span class="p">}</span>
    <span class="c1">// Handle data change from UI and emit "json" event into socket</span>
    <span class="nx">onFieldChange</span><span class="p">(</span><span class="na">payload</span><span class="p">:</span> <span class="p">{</span><span class="na">name</span><span class="p">:</span> <span class="nx">string</span><span class="p">,</span> <span class="na">value</span><span class="p">:</span> <span class="nx">any</span><span class="p">})</span> <span class="p">{</span>
        <span class="k">this</span><span class="p">.</span><span class="nx">mainSocket</span><span class="p">.</span><span class="nx">emit</span><span class="p">(</span><span class="dl">'</span><span class="s1">json</span><span class="dl">'</span><span class="p">,</span> <span class="p">{</span>
            <span class="na">data</span><span class="p">:</span> <span class="p">{</span>
                <span class="na">name</span><span class="p">:</span> <span class="nx">payload</span><span class="p">.</span><span class="nx">name</span><span class="p">,</span>
                <span class="na">value</span><span class="p">:</span> <span class="nx">payload</span><span class="p">.</span><span class="nx">value</span><span class="p">,</span>
            <span class="p">}</span>
        <span class="p">});</span>
    <span class="p">}</span>

    <span class="nx">ngOnDestroy</span><span class="p">()</span> <span class="p">{</span>
        <span class="k">this</span><span class="p">.</span><span class="nx">socketSubscribe</span> <span class="o">&amp;&amp;</span> <span class="k">this</span><span class="p">.</span><span class="nx">socketSubscribe</span><span class="p">.</span><span class="nx">unsubscribe</span><span class="p">();</span>
    <span class="p">}</span>
<span class="p">}</span></code></pre></figure> <h2 id="flask-a-socketio">Flask a socket.io</h2> <p>Webových frameworků v Pythonu jsou samozřejmě tuny. Pojďme ale použít něco jednoduchého, do čeho se dobře integruje socket.io. Volba padla na <a href="http://flask.pocoo.org/">Flask</a>, pár lidí ho <a href="https://hotframeworks.com/languages/python">používá</a> a socket.io to <a href="https://flask-socketio.readthedocs.io/en/latest/">taky umí</a>. Přijímat data z klienta je pak přímo odzbrojujícím způsobem jednoduché.</p> <figure class="highlight"><pre><code class="language-python" data-lang="python"><span class="kn">from</span> <span class="nn">flask</span> <span class="kn">import</span> <span class="n">Flask</span>
<span class="kn">from</span> <span class="nn">flask_socketio</span> <span class="kn">import</span> <span class="n">SocketIO</span>
<span class="kn">from</span> <span class="nn">flask_cors</span> <span class="kn">import</span> <span class="n">CORS</span>

<span class="n">app</span> <span class="o">=</span> <span class="n">Flask</span><span class="p">(</span><span class="n">__name__</span><span class="p">)</span>
<span class="n">app</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">from_envvar</span><span class="p">(</span><span class="s">'FLASKR_SETTINGS'</span><span class="p">,</span> <span class="n">silent</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>

<span class="n">CORS</span><span class="p">(</span><span class="n">app</span><span class="p">)</span>
<span class="n">socketio</span> <span class="o">=</span> <span class="n">SocketIO</span><span class="p">(</span><span class="n">app</span><span class="p">)</span>

<span class="c1"># Handles messages of type "json"
</span><span class="o">@</span><span class="n">socketio</span><span class="o">.</span><span class="n">on</span><span class="p">(</span><span class="s">'json'</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">client_data_change</span><span class="p">(</span><span class="n">message</span><span class="p">):</span>
    <span class="n">database</span><span class="o">.</span><span class="n">update_value</span><span class="p">(</span><span class="n">message</span><span class="p">[</span><span class="s">'data'</span><span class="p">][</span><span class="s">'name'</span><span class="p">],</span> <span class="n">message</span><span class="p">[</span><span class="s">'data'</span><span class="p">][</span><span class="s">'value'</span><span class="p">])</span></code></pre></figure> <p>Jak se data na klienta posílají si ukážeme po krátké odbočce do světa databází.</p> <h2 id="sqlite-postgresql-a-listennotify">SqLite, PostgreSQL a LISTEN/NOTIFY</h2> <p>Když už se pollingem, tedy periodickou kontrolou dat nezabýváme na ose prohlížeč-server, byla by škoda dělat polling do databáze. Na scénu tak vstupují SQLite a PostgreSQL, které umí pomocí <a href="https://www.sqlite.org/c3ref/update_hook.html">update_hook</a> respektive dvojice <a href="https://www.postgresql.org/docs/9.4/static/sql-listen.html">LISTEN</a>/<a href="https://www.postgresql.org/docs/9.4/static/sql-notify.html">NOTIFY</a> při nějaké události volat uživatelský kód. Pro SQLite se dá použít například knihovna <a href="https://github.com/karellen/karellen-sqlite">karellen-sqlite</a>, my si ukážeme, jak se problém řeší v Postgresu a <a href="http://initd.org/psycopg/">psycopg2</a>.</p> <p>V PostgreSQL mějme jednoduchou tabulku, z níž chceme zavolat NOTIFY pokaždé, když do ní přibude nový řádek. Na to se samozřejme nejlépe používají triggery.</p> <figure class="highlight"><pre><code class="language-sql" data-lang="sql"><span class="c1">-- simple table definition, sequence omitted</span>
<span class="k">CREATE</span> <span class="k">TABLE</span> <span class="n">field_value</span> <span class="p">(</span>
    <span class="n">id</span> <span class="nb">integer</span> <span class="k">NOT</span> <span class="k">NULL</span><span class="p">,</span>
    <span class="n">value</span> <span class="nb">character</span> <span class="nb">varying</span><span class="p">(</span><span class="mi">255</span><span class="p">)</span> <span class="k">NOT</span> <span class="k">NULL</span><span class="p">,</span>
    <span class="n">field</span> <span class="nb">character</span> <span class="nb">varying</span><span class="p">(</span><span class="mi">80</span><span class="p">)</span>
<span class="p">);</span>

<span class="k">CREATE</span> <span class="k">FUNCTION</span> <span class="n">field_value_notify_change</span><span class="p">()</span> <span class="k">RETURNS</span> <span class="k">trigger</span>
    <span class="k">LANGUAGE</span> <span class="n">plpgsql</span>
    <span class="k">AS</span> <span class="err">$$</span>
<span class="k">DECLARE</span>
    <span class="n">payload</span> <span class="n">jsonb</span><span class="p">;</span>
<span class="k">BEGIN</span>
    <span class="c1">-- build JSON object, compatible with 9.4 and 9.5</span>
    <span class="n">payload</span> <span class="o">=</span> <span class="n">json_build_object</span><span class="p">(</span><span class="s1">'field'</span><span class="p">,</span> <span class="k">NEW</span><span class="p">.</span><span class="n">field</span><span class="p">,</span> <span class="s1">'value'</span><span class="p">,</span> <span class="k">NEW</span><span class="p">.</span><span class="n">value</span><span class="p">);</span>
    <span class="c1">-- this is the magic, that emits the real event</span>
    <span class="n">perform</span> <span class="n">pg_notify</span><span class="p">(</span><span class="s1">'field_value_change'</span><span class="p">,</span> <span class="n">payload</span><span class="p">::</span><span class="nb">text</span><span class="p">);</span>
    <span class="k">RETURN</span> <span class="k">NULL</span><span class="p">;</span>
<span class="k">END</span>
<span class="err">$$</span><span class="p">;</span>

<span class="c1">-- regsiter function as a table trigger</span>
<span class="k">CREATE</span> <span class="k">TRIGGER</span> <span class="n">on_field_value_change</span> <span class="k">AFTER</span> <span class="k">INSERT</span> <span class="k">ON</span> <span class="n">field_value</span> <span class="k">FOR</span> <span class="k">EACH</span> <span class="k">ROW</span> <span class="k">EXECUTE</span> <span class="k">PROCEDURE</span> <span class="n">field_value_notify_change</span><span class="p">();</span></code></pre></figure> <p>Obsluha v Pythonu je pak dost jednoduchá, ale pro webový server je blokující smyčka tak, jak je uvedená v dokumentaci, poměrně nevhodná.</p> <figure class="highlight"><pre><code class="language-python" data-lang="python"><span class="c1"># http://initd.org/psycopg/docs/advanced.html#asynchronous-notifications
</span><span class="kn">import</span> <span class="nn">select</span>
<span class="kn">import</span> <span class="nn">psycopg2</span>
<span class="kn">import</span> <span class="nn">psycopg2.extensions</span>

<span class="n">conn</span> <span class="o">=</span> <span class="n">psycopg2</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="n">DSN</span><span class="p">)</span>
<span class="n">conn</span><span class="o">.</span><span class="n">set_isolation_level</span><span class="p">(</span><span class="n">psycopg2</span><span class="o">.</span><span class="n">extensions</span><span class="o">.</span><span class="n">ISOLATION_LEVEL_AUTOCOMMIT</span><span class="p">)</span>

<span class="n">curs</span> <span class="o">=</span> <span class="n">conn</span><span class="o">.</span><span class="n">cursor</span><span class="p">()</span>
<span class="n">cursor</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="s">"LISTEN field_value_change"</span><span class="p">)</span>

<span class="k">print</span> <span class="s">"Waiting for notifications on channel 'test'"</span>
<span class="k">while</span> <span class="mi">1</span><span class="p">:</span>
    <span class="k">if</span> <span class="n">select</span><span class="o">.</span><span class="n">select</span><span class="p">([</span><span class="n">conn</span><span class="p">],[],[],</span><span class="mi">5</span><span class="p">)</span> <span class="o">==</span> <span class="p">([],[],[]):</span>
        <span class="k">print</span> <span class="s">"Timeout"</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">conn</span><span class="o">.</span><span class="n">poll</span><span class="p">()</span>
        <span class="k">while</span> <span class="n">conn</span><span class="o">.</span><span class="n">notifies</span><span class="p">:</span>
            <span class="n">notify</span> <span class="o">=</span> <span class="n">conn</span><span class="o">.</span><span class="n">notifies</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
            <span class="k">print</span> <span class="s">"Got NOTIFY:"</span><span class="p">,</span> <span class="n">notify</span><span class="o">.</span><span class="n">pid</span><span class="p">,</span> <span class="n">notify</span><span class="o">.</span><span class="n">channel</span><span class="p">,</span> <span class="n">notify</span><span class="o">.</span><span class="n">payload</span></code></pre></figure> <h2 id="lepíme-to-celé-dohromady">Lepíme to celé dohromady</h2> <p>Naštěstí máme <a href="https://flask-socketio.readthedocs.io/en/latest/">flask-socketio</a> a v něm zprovozněný <a href="http://eventlet.net/">eventlet</a>, takže se té blokující smyčky můžeme elegantně zbavit. Použijeme na to dva background tasky (v podstatě samostatná vlákna) v režii socket.io a asynchronní frontu s <a href="http://eventlet.net/doc/hubs.html?highlight=trampoline#eventlet.hubs.trampoline">trampolínou</a> z arzenálu knihovny eventlet. Celá nádhera tak vypadá následovně:</p> <figure class="highlight"><pre><code class="language-python" data-lang="python"><span class="kn">from</span> <span class="nn">eventlet.hubs</span> <span class="kn">import</span> <span class="n">trampoline</span>

<span class="k">def</span> <span class="nf">start_listening</span><span class="p">(</span><span class="n">queue</span><span class="p">):</span>
    <span class="s">"""Connects to PgSQL and listens to notifications, inspired by http://initd.org/psycopg/articles/2010/12/01/postgresql-notifications-psycopg2-eventlet/"""</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">queue</span><span class="p">:</span>
        <span class="k">return</span>
    <span class="n">connection</span> <span class="o">=</span> <span class="n">psycopg2</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="n">DSN</span><span class="p">)</span>
    <span class="n">cursor</span> <span class="o">=</span> <span class="n">connection</span><span class="o">.</span><span class="n">cursor</span><span class="p">()</span>
    <span class="n">cursor</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="s">"LISTEN field_value_change"</span><span class="p">)</span>

    <span class="k">while</span> <span class="bp">True</span><span class="p">:</span>
        <span class="n">trampoline</span><span class="p">(</span><span class="n">connection</span><span class="p">,</span> <span class="n">read</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
        <span class="n">connection</span><span class="o">.</span><span class="n">poll</span><span class="p">()</span>
        <span class="k">while</span> <span class="n">connection</span><span class="o">.</span><span class="n">notifies</span><span class="p">:</span>
            <span class="n">notify</span> <span class="o">=</span> <span class="n">connection</span><span class="o">.</span><span class="n">notifies</span><span class="o">.</span><span class="n">pop</span><span class="p">()</span>
            <span class="n">queue</span><span class="o">.</span><span class="n">put</span><span class="p">(</span><span class="n">json</span><span class="o">.</span><span class="n">loads</span><span class="p">(</span><span class="n">notify</span><span class="o">.</span><span class="n">payload</span><span class="p">))</span>

<span class="k">def</span> <span class="nf">emitter</span><span class="p">(</span><span class="n">queue</span><span class="p">):</span>
    <span class="s">"""Listens to queued events and emits data_changed broadcast event to a socket"""</span>
    <span class="k">while</span> <span class="bp">True</span><span class="p">:</span>
        <span class="n">element</span> <span class="o">=</span> <span class="n">queue</span><span class="o">.</span><span class="n">get</span><span class="p">()</span>
        <span class="n">socketio</span><span class="o">.</span><span class="n">emit</span><span class="p">(</span><span class="s">'data_changed'</span><span class="p">,</span> <span class="p">{</span><span class="s">'data'</span><span class="p">:</span> <span class="p">{</span><span class="s">'name'</span><span class="p">:</span> <span class="n">element</span><span class="p">[</span><span class="s">'field'</span><span class="p">],</span> <span class="s">'value'</span><span class="p">:</span> <span class="n">element</span><span class="p">[</span><span class="s">'value'</span><span class="p">]}},</span> <span class="n">broadcast</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>

<span class="c1"># ...
</span>
<span class="n">dbThread</span> <span class="o">=</span> <span class="bp">None</span>
<span class="n">qThread</span> <span class="o">=</span> <span class="bp">None</span>

<span class="o">@</span><span class="n">socketio</span><span class="o">.</span><span class="n">on</span><span class="p">(</span><span class="s">'connect'</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">connect</span><span class="p">():</span>
    <span class="s">"""On first socket.io connection registers the database listener and value emitter"""</span>
    <span class="k">global</span> <span class="n">dbThread</span>
    <span class="k">global</span> <span class="n">qThread</span>
    <span class="n">q</span> <span class="o">=</span> <span class="n">eventlet</span><span class="o">.</span><span class="n">Queue</span><span class="p">()</span>
    <span class="k">if</span> <span class="n">dbThread</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
        <span class="n">dbThread</span> <span class="o">=</span> <span class="n">socketio</span><span class="o">.</span><span class="n">start_background_task</span><span class="p">(</span><span class="n">target</span><span class="o">=</span><span class="n">start_listening</span><span class="p">,</span> <span class="n">queue</span><span class="o">=</span><span class="n">q</span><span class="p">)</span>
        <span class="n">qThread</span> <span class="o">=</span> <span class="n">socketio</span><span class="o">.</span><span class="n">start_background_task</span><span class="p">(</span><span class="n">target</span><span class="o">=</span><span class="n">emitter</span><span class="p">,</span> <span class="n">queue</span><span class="o">=</span><span class="n">q</span><span class="p">)</span></code></pre></figure> <p>Neumíte si to představit? Podívejte se na následující video, kde je navíc v provozu i REST API, aby se nemuselo sahat přímo do databáze:</p> <iframe width="640" height="360" src="https://www.youtube.com/embed/y8cdWyMp_KE" frameborder="0" allowfullscreen=""></iframe> <h2 id="co-říci-závěrem">Co říci závěrem</h2> <p>Díky menší zoologické zahradě existujících technologií a knihoven jsme takhle byli schopní během pár dnů dodat firmě na balicí stroje pilotní ukázku toho, jak by mohl vypadat reálný řídící panel s různými komponentami. Angular nám pomohl k tomu, že řešení je modulární a z jednotlivých komponent se dají skládat různé obrazovky. Dostatečně obecné řešení backendu pomocí PostgreSQL a WebSockets pak umožňuje snadnou rozšiřitelnost a přizpůsobování podle toho, jaké typy dat potřebují jednotlivé stroje.</p> <p>Když už frčí to reaktivní programování na frontendu, tímhle relativně jednoduchým způsobem můžete postavit reaktivní celou aplikaci odshora dolů. To samozřejmě šetří zdroje, možná to zlepšuje uživatelský prožitek, ale hlavně to setsakra dobře vypadá.</p> </div> </div> </div> <div class="content-block"> <div class="article__misc"> <div class="article__miscitem"> <div class="taglist " itemscope itemtype="http://schema.org/WebPage"> <a class="taglist__tag anchor anchor--emphasized" href="/blog/archive/tag/sqlite/" itemprop="relatedLink">sqlite, </a> <a class="taglist__tag anchor anchor--emphasized" href="/blog/archive/tag/javascript/" itemprop="relatedLink">javascript, </a> <a class="taglist__tag anchor anchor--emphasized" href="/blog/archive/tag/python/" itemprop="relatedLink">python, </a> <a class="taglist__tag anchor anchor--emphasized" href="/blog/archive/tag/flask/" itemprop="relatedLink">flask, </a> <a class="taglist__tag anchor anchor--emphasized" href="/blog/archive/tag/angular/" itemprop="relatedLink">angular, </a> <a class="taglist__tag anchor anchor--emphasized" href="/blog/archive/tag/socket.io/" itemprop="relatedLink">socket.io, </a> <a class="taglist__tag anchor anchor--emphasized" href="/blog/archive/tag/eventlet/" itemprop="relatedLink">eventlet, </a> <a class="taglist__tag anchor anchor--emphasized" href="/blog/archive/tag/postgresql/" itemprop="relatedLink">postgresql, </a> <a class="taglist__tag anchor anchor--emphasized" href="/blog/archive/tag/raspberry/" itemprop="relatedLink">raspberry, </a> <a class="taglist__tag anchor anchor--emphasized" href="/blog/archive/tag/rest/" itemprop="relatedLink">rest</a> </div> </div> <div class="article__miscitem"> <div class="sharebox"> <ul class="sharebox__items"> <li class="sharebox__item sharebox__item--twitter"> <a class="sharebox__item-body" href="https://twitter.com/intent/tweet?text=Jahoda, malina, sloni, hadi, flanděra, angular&url=https://fragaria.cz/blog/2017/07/03/jahoda-malina-sloni-hadi-flandera/&via=&related=" target="_blank" rel="noopener" title="Share on Twitter"><span>Share on Twitter</span></a> </li> <li class="sharebox__item sharebox__item--facebook"> <a class="sharebox__item-body" href="https://facebook.com/sharer.php?u=https://fragaria.cz/blog/2017/07/03/jahoda-malina-sloni-hadi-flandera/" target="_blank" rel="noopener" title="Share on Facebook"><span>Share on Facebook</span></a> </li> </ul> </div> </div> </div> </div> </article> <footer class="content-block"> <div class="footer"> <div class="footer__meta"> <a href="/"> <img alt="Fragaria s.r.o." class="footer__brand" src="/assets/img/strawberry.svg"> </a> <div class="footer__copy"> <div class="footer__copy-line footer__copy-line--emphasized">FRAGARIA &copy; 2019</div> <div class="footer__copy-line">Talk is cheap, show me the code.</div> </div> </div> <div class="footer__social"> <a href="https://twitter.com/fragariacz" class="icon--twitter footer__social-icon" title="Twitter profile page"></a> <a href="https://linkedin.com/company/fragaria-ltd-" class="icon--linkedin footer__social-icon" title="LinkedIn profile page"></a> <a href="https://github.com/fragaria" class="icon--github footer__social-icon" title="GitHub profile page"></a> <a href="https://stackshare.io/fragaria" class="icon--stackshare footer__social-icon" title="Stackshare profile page"></a> </div> </div> </footer> </div> </div> <script src="https://cdn.jsdelivr.net/npm/cookieconsent@3/build/cookieconsent.min.js" data-cfasync="false"></script> <script src="/assets/js/smoothscroll.js"></script> <script src="/assets/js/element-closest.js"></script> <script src="/assets/js/site.js?906be5e74733e0c75a9b8bc048028f1f"></script> <script type="text/javascript" src="/assets/js/register-sw.js"></script> </body> </html>